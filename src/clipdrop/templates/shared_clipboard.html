{% extends "base.html" %}
{% from "macros.html" import page_header, section_header, flash_messages, empty_state, file_icon %}

{% block title %}Clipboard - ClipDrop{% endblock %}

{% block content %}
<!-- Page Header -->
{{ page_header('Clipboard', 'fa-clipboard-list', 'Share text and images instantly') }}

<!-- Flash Messages -->
{{ flash_messages() }}

<!-- Quick Paste Section -->
<div class="page-card mb-4">
    {{ section_header('Quick Paste', 'fa-paste') }}
    <form id="clipboard-form">
        <div class="form-group">
            <label for="clipboard-text" class="sr-only">Text to save</label>
            <textarea id="clipboard-text" class="form-control" rows="3" placeholder="Paste or type text here..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save" aria-hidden="true"></i> Save to Clipboard
        </button>
    </form>
</div>

<!-- Clipboard Items -->
<div class="page-card">
    {{ section_header('Recent Items', 'fa-history', badge=clipboard_files | length ~ ' items') }}

    {% if clipboard_files %}
    <div class="table-container">
        <table class="table clipboard-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>File Name</th>
                    <th>Size</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for file in clipboard_files %}
                <tr>
                    <td>
                        <i class="fas {{ file_icon(file.extension) }}" aria-hidden="true"></i>
                        <span class="sr-only">{{ file.extension or 'Text' }} file</span>
                    </td>
                    <td class="filename-cell" title="{{ file.name }}">{{ file.name }}</td>
                    <td>{{ file.size_human }}</td>
                    <td>{{ file.creation_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <div class="btn-group-actions">
                            {% if file.name.endswith('.txt') %}
                            <button class="btn btn-primary btn-sm copy-content-btn" data-content="{{ file.content | e }}" aria-label="Copy {{ file.name }}">
                                <i class="fas fa-copy" aria-hidden="true"></i>
                            </button>
                            {% endif %}
                            <a href="{{ url_for('clipboard_file', filename=file.name) }}" class="btn btn-outline-primary btn-sm" aria-label="View {{ file.name }}">
                                <i class="fas fa-eye" aria-hidden="true"></i>
                            </a>
                            <button class="btn btn-success btn-sm share-btn" data-url="{{ url_for('clipboard_file', filename=file.name, _external=True) }}" aria-label="Copy link">
                                <i class="fas fa-link" aria-hidden="true"></i>
                            </button>
                            <a href="{{ url_for('clipboard_file_raw', filename=file.name) }}" class="btn btn-info btn-sm" aria-label="Download" download>
                                <i class="fas fa-download" aria-hidden="true"></i>
                            </a>
                            <button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file.name }}" aria-label="Delete">
                                <i class="fas fa-trash" aria-hidden="true"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    {{ empty_state('fa-clipboard', 'No clipboard items yet', 'Use the Quick Paste form above to add your first item') }}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/clipboard.js') }}"></script>
<script>
    document.getElementById('clipboard-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        const text = document.getElementById('clipboard-text').value.trim();

        if (!text) {
            showToast('Please enter some text', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('clipboard_data', text);

        try {
            const response = await fetch('/clipboard', { method: 'POST', body: formData });
            const result = await response.json();

            if (result.status === 'success') {
                showToast('Saved to clipboard!', 'success');
                setTimeout(() => location.reload(), 5000);
            } else {
                showToast(result.message || 'Failed to save', 'error');
            }
        } catch (error) {
            showToast('Failed to save', 'error');
        }
    });

    document.querySelectorAll('.copy-content-btn').forEach(button => {
        button.addEventListener('click', async () => {
            const content = button.getAttribute('data-content');
            try {
                await navigator.clipboard.writeText(content);
                showToast('Copied to clipboard!', 'success');

                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check" aria-hidden="true"></i>';
                button.classList.add('btn-success');
                button.classList.remove('btn-primary');

                setTimeout(() => {
                    button.innerHTML = originalHtml;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-primary');
                }, 2000);
            } catch (err) {
                showToast('Failed to copy', 'error');
            }
        });
    });

    document.querySelectorAll('.share-btn').forEach(button => {
        button.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(button.getAttribute('data-url'));
                showToast('Link copied!', 'success');
            } catch (err) {
                showToast('Failed to copy link', 'error');
            }
        });
    });

    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', () => {
            const filename = button.getAttribute('data-filename');
            const itemName = filename.length > 30 ? filename.substring(0, 30) + '...' : filename;

            showConfirmModal({
                title: 'Delete Clipboard Item',
                message: `Are you sure you want to delete "${itemName}"? This action cannot be undone.`,
                confirmText: 'Delete',
                onConfirm: async () => {
                    try {
                        const response = await fetch(`/delete/clipboard/${filename}`, { method: 'DELETE' });
                        const result = await response.json();

                        if (result.status === 'success') {
                            showToast('Deleted!', 'success');
                            setTimeout(() => location.reload(), 5000);
                        } else {
                            showToast(result.message || 'Failed to delete', 'error');
                        }
                    } catch (error) {
                        showToast('Failed to delete', 'error');
                    }
                }
            });
        });
    });
</script>
{% endblock %}
