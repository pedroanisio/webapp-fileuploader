{% extends "base.html" %}
{% from "macros.html" import page_header, section_header, flash_messages, empty_state, file_icon %}

{% block title %}Files - ClipDrop{% endblock %}

{% block content %}
<!-- Page Header -->
{{ page_header('Files', 'fa-cloud-upload-alt', 'Upload and share files securely') }}

<!-- Flash Messages -->
{{ flash_messages() }}

<!-- Upload Section -->
<div class="page-card mb-4">
    {{ section_header('Upload Files', 'fa-upload', badge=allowed_extensions | join(', ')) }}
    <form id="upload-form" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <input type="file" name="file" id="file-input" class="form-control-file d-none">
        </div>
        <div id="drag-drop-area" class="drag-drop-area">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3" aria-hidden="true"></i>
            <p>Drag & Drop files here or click to select files</p>
        </div>
        <div id="upload-progress" class="progress progress-lg mt-3" style="display: none;">
            <div id="progress-bar" class="progress-bar is-animated"
                 role="progressbar"
                 aria-valuenow="0"
                 aria-valuemin="0"
                 aria-valuemax="100"
                 aria-label="Upload progress">
                0%
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">
            <i class="fas fa-upload" aria-hidden="true"></i> Upload
        </button>
    </form>
</div>

<!-- Files Section -->
<div class="page-card">
    {{ section_header('Your Files', 'fa-folder-open', badge=files | length ~ ' files') }}
    {% if files %}
    <div class="table-container">
        <table class="table files-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>File Name</th>
                    <th>Size</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                <tr>
                    <td>
                        <i class="fas {{ file_icon(file.extension) }}" aria-hidden="true"></i>
                        <span class="sr-only">{{ file.extension or 'Unknown' }} file</span>
                    </td>
                    <td class="filename-cell" title="{{ file.name }}">{{ file.name }}</td>
                    <td>{{ file.size_human }}</td>
                    <td>{{ file.creation_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <div class="btn-group-actions">
                            <a href="{{ url_for('uploaded_file', filename=file.name) }}" class="btn btn-info btn-sm" aria-label="Download {{ file.name }}">
                                <i class="fas fa-download" aria-hidden="true"></i>
                            </a>
                            <button class="btn btn-success btn-sm share-btn" data-url="{{ url_for('uploaded_file', filename=file.name, _external=True) }}" aria-label="Share {{ file.name }}">
                                <i class="fas fa-share-alt" aria-hidden="true"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file.name }}" data-type="file" aria-label="Delete {{ file.name }}">
                                <i class="fas fa-trash" aria-hidden="true"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    {{ empty_state('fa-folder-open', 'No files uploaded yet', 'Drag and drop files above to get started') }}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/files.js') }}"></script>
<script>
    const fileInput = document.getElementById('file-input');
    const dragDropArea = document.getElementById('drag-drop-area');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');

    dragDropArea.addEventListener('click', () => fileInput.click());

    function uploadWithProgress(files) {
        const formData = new FormData();
        formData.append('file', files[0]);

        uploadProgress.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
                progressBar.setAttribute('aria-valuenow', percentComplete);
            }
        });

        xhr.addEventListener('load', () => {
            const response = xhr.response || {};
            if (xhr.status >= 200 && xhr.status < 300 && response.status === 'success') {
                showToast(response.message || 'File uploaded!', 'success');
                setTimeout(() => location.reload(), 5000);
            } else {
                showToast(response.message || 'Upload failed.', 'error');
                uploadProgress.style.display = 'none';
            }
        });

        xhr.addEventListener('error', () => {
            showToast('Upload failed.', 'error');
            uploadProgress.style.display = 'none';
        });

        xhr.open('POST', '/');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.responseType = 'json';
        xhr.send(formData);
    }

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) uploadWithProgress(fileInput.files);
    });

    dragDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dragDropArea.classList.add('drag-over');
    });

    dragDropArea.addEventListener('dragleave', () => dragDropArea.classList.remove('drag-over'));

    dragDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dragDropArea.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) uploadWithProgress(e.dataTransfer.files);
    });

    // Share button handlers
    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            navigator.clipboard.writeText(e.currentTarget.getAttribute('data-url'))
                .then(() => showToast('Link copied!', 'success'))
                .catch(() => showToast('Failed to copy.', 'error'));
        });
    });

    // Delete button handlers using confirmation modal
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const filename = e.currentTarget.getAttribute('data-filename');
            const itemName = filename.length > 30 ? filename.substring(0, 30) + '...' : filename;

            showConfirmModal({
                title: 'Delete File',
                message: `Are you sure you want to delete "${itemName}"? This action cannot be undone.`,
                confirmText: 'Delete',
                onConfirm: async () => {
                    try {
                        const response = await fetch(`/delete/${filename}`, { method: 'DELETE' });
                        const result = await response.json();
                        if (result.status === 'success') {
                            showToast('Deleted!', 'success');
                            setTimeout(() => location.reload(), 5000);
                        } else {
                            showToast(result.message || 'Failed to delete.', 'error');
                        }
                    } catch { showToast('Failed to delete.', 'error'); }
                }
            });
        });
    });
</script>
{% endblock %}
