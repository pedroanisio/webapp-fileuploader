{% extends "base.html" %}

{% block title %}Files - ClipDrop{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <h1 class="page-title"><i class="fas fa-cloud-upload-alt" aria-hidden="true"></i> Files</h1>
    <p class="page-subtitle">Upload and share files securely</p>
</div>

{% with messages = get_flashed_messages(with_categories=True) %}
  {% if messages %}
    <div class="mb-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {% if category == 'success' %}
            <i class="fas fa-check-circle mr-2" aria-hidden="true"></i>
          {% elif category == 'danger' %}
            <i class="fas fa-times-circle mr-2" aria-hidden="true"></i>
          {% elif category == 'warning' %}
            <i class="fas fa-exclamation-triangle mr-2" aria-hidden="true"></i>
          {% else %}
            <i class="fas fa-info-circle mr-2" aria-hidden="true"></i>
          {% endif %}
          <span>{{ message }}</span>
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<!-- Upload Section -->
<div class="page-card mb-4">
    <div class="section-header">
        <h2 class="section-title"><i class="fas fa-upload" aria-hidden="true"></i> Upload Files</h2>
        <span class="section-badge">{{ allowed_extensions | join(', ') }}</span>
    </div>
    <form id="upload-form" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <input type="file" name="file" id="file-input" class="form-control-file d-none">
        </div>
        <div id="drag-drop-area" class="drag-drop-area">
            <i class="fas fa-cloud-upload-alt fa-3x mb-3" aria-hidden="true"></i>
            <p>Drag & Drop files here or click to select files</p>
        </div>
        <div id="upload-progress" class="progress progress-lg mt-3" style="display: none;">
            <div id="progress-bar" class="progress-bar is-animated"
                 role="progressbar"
                 aria-valuenow="0"
                 aria-valuemin="0"
                 aria-valuemax="100"
                 aria-label="Upload progress">
                0%
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">
            <i class="fas fa-upload" aria-hidden="true"></i> Upload
        </button>
    </form>
</div>

<!-- Files Section -->
<div class="page-card mb-4">
    <div class="section-header">
        <h2 class="section-title"><i class="fas fa-folder-open" aria-hidden="true"></i> Your Files</h2>
        <span class="section-badge">{{ files | length }} files</span>
    </div>
    {% if files %}
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>File Name</th>
                    <th>Size</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for file in files %}
                <tr>
                    <td>
                        {% if file.extension in ['png', 'jpg', 'jpeg', 'gif'] %}
                            <i class="fas fa-file-image text-info" aria-hidden="true"></i>
                            <span class="sr-only">Image file</span>
                        {% elif file.extension == 'pdf' %}
                            <i class="fas fa-file-pdf text-danger" aria-hidden="true"></i>
                            <span class="sr-only">PDF file</span>
                        {% elif file.extension == 'txt' %}
                            <i class="fas fa-file-alt text-secondary" aria-hidden="true"></i>
                            <span class="sr-only">Text file</span>
                        {% elif file.extension == 'pst' %}
                            <i class="fas fa-envelope text-warning" aria-hidden="true"></i>
                            <span class="sr-only">Outlook PST file</span>
                        {% else %}
                            <i class="fas fa-file text-muted" aria-hidden="true"></i>
                            <span class="sr-only">File</span>
                        {% endif %}
                    </td>
                    <td class="filename-cell" title="{{ file.name }}">{{ file.name }}</td>
                    <td>{{ file.size_human }}</td>
                    <td>{{ file.creation_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <div class="btn-group-actions">
                            <a href="{{ url_for('uploaded_file', filename=file.name) }}" class="btn btn-info btn-sm" aria-label="Download {{ file.name }}">
                                <i class="fas fa-download" aria-hidden="true"></i>
                            </a>
                            <button class="btn btn-success btn-sm share-btn" data-url="{{ url_for('uploaded_file', filename=file.name, _external=True) }}" aria-label="Share {{ file.name }}">
                                <i class="fas fa-share-alt" aria-hidden="true"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file.name }}" data-type="file" aria-label="Delete {{ file.name }}">
                                <i class="fas fa-trash" aria-hidden="true"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-folder-open" aria-hidden="true"></i>
        <h4>No files uploaded yet</h4>
        <p>Drag and drop files above to get started</p>
    </div>
    {% endif %}
</div>

<!-- Quick Clipboard Section -->
<div class="page-card">
    <div class="section-header">
        <h2 class="section-title"><i class="fas fa-clipboard" aria-hidden="true"></i> Quick Clipboard</h2>
        <a href="{{ url_for('shared_clipboard') }}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-external-link-alt" aria-hidden="true"></i> View All
        </a>
    </div>
    <form id="clipboard-form" method="post" class="mb-4">
        <div class="form-group">
            <label for="clipboard-text" class="sr-only">Clipboard text</label>
            <textarea id="clipboard-text" class="form-control" rows="3" placeholder="Paste text here to share..."></textarea>
        </div>
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save" aria-hidden="true"></i> Save Clipboard
        </button>
    </form>

    {% if clipboard_files %}
    <div class="clipboard-grid">
        {% for file in clipboard_files[:4] %}
        <div class="clipboard-card">
            <div class="clipboard-card-header">
                {% if file.extension in ['png', 'jpg', 'jpeg', 'gif'] %}
                    <i class="fas fa-file-image text-info" aria-hidden="true"></i>
                {% else %}
                    <i class="fas fa-file-alt text-secondary" aria-hidden="true"></i>
                {% endif %}
                <span class="filename-truncate" title="{{ file.name }}">{{ file.name }}</span>
            </div>
            <div class="clipboard-card-actions">
                {% if file.name.endswith('.txt') %}
                <button class="btn btn-secondary btn-sm copy-btn" data-text="{{ file.content | e }}" aria-label="Copy {{ file.name }}">
                    <i class="fas fa-copy" aria-hidden="true"></i>
                </button>
                {% endif %}
                <a href="{{ url_for('clipboard_file_raw', filename=file.name) }}" class="btn btn-info btn-sm" aria-label="Download {{ file.name }}">
                    <i class="fas fa-download" aria-hidden="true"></i>
                </a>
                <button class="btn btn-success btn-sm share-btn" data-url="{{ url_for('clipboard_file', filename=file.name, _external=True) }}" aria-label="Share {{ file.name }}">
                    <i class="fas fa-share-alt" aria-hidden="true"></i>
                </button>
                <button class="btn btn-danger btn-sm delete-btn" data-filename="{{ file.name }}" data-type="clipboard" aria-label="Delete {{ file.name }}">
                    <i class="fas fa-trash" aria-hidden="true"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% if clipboard_files | length > 4 %}
    <div class="text-center mt-3">
        <a href="{{ url_for('shared_clipboard') }}" class="btn btn-outline-primary">
            View all {{ clipboard_files | length }} items <i class="fas fa-arrow-right" aria-hidden="true"></i>
        </a>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    const fileInput = document.getElementById('file-input');
    const dragDropArea = document.getElementById('drag-drop-area');
    const clipboardForm = document.getElementById('clipboard-form');
    const clipboardText = document.getElementById('clipboard-text');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');

    dragDropArea.addEventListener('click', () => fileInput.click());

    function uploadWithProgress(files) {
        const formData = new FormData();
        formData.append('file', files[0]);

        uploadProgress.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
                progressBar.setAttribute('aria-valuenow', percentComplete);
            }
        });

        xhr.addEventListener('load', () => {
            const response = xhr.response || {};
            if (xhr.status >= 200 && xhr.status < 300 && response.status === 'success') {
                showToast(response.message || 'File uploaded!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(response.message || 'Upload failed.', 'error');
                uploadProgress.style.display = 'none';
            }
        });

        xhr.addEventListener('error', () => {
            showToast('Upload failed.', 'error');
            uploadProgress.style.display = 'none';
        });

        xhr.open('POST', '/');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.responseType = 'json';
        xhr.send(formData);
    }

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) uploadWithProgress(fileInput.files);
    });

    dragDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dragDropArea.classList.add('drag-over');
    });

    dragDropArea.addEventListener('dragleave', () => dragDropArea.classList.remove('drag-over'));

    dragDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dragDropArea.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) uploadWithProgress(e.dataTransfer.files);
    });

    clipboardForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('clipboard_data', clipboardText.value);
        const response = await fetch('/clipboard', { method: 'POST', body: formData });
        const result = await response.json();
        if (result.status === 'success') {
            showToast('Clipboard saved!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(result.message, 'error');
        }
    });

    document.querySelectorAll('.copy-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            navigator.clipboard.writeText(e.currentTarget.getAttribute('data-text'))
                .then(() => showToast('Copied!', 'success'))
                .catch(() => showToast('Failed to copy.', 'error'));
        });
    });

    document.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            navigator.clipboard.writeText(e.currentTarget.getAttribute('data-url'))
                .then(() => showToast('Link copied!', 'success'))
                .catch(() => showToast('Failed to copy.', 'error'));
        });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const filename = e.currentTarget.getAttribute('data-filename');
            const type = e.currentTarget.getAttribute('data-type');
            const itemName = filename.length > 30 ? filename.substring(0, 30) + '...' : filename;

            showConfirmModal({
                title: 'Delete ' + (type === 'clipboard' ? 'Clipboard Item' : 'File'),
                message: `Are you sure you want to delete "${itemName}"? This action cannot be undone.`,
                confirmText: 'Delete',
                onConfirm: async () => {
                    const url = type === 'clipboard' ? `/delete/clipboard/${filename}` : `/delete/${filename}`;
                    try {
                        const response = await fetch(url, { method: 'DELETE' });
                        const result = await response.json();
                        if (result.status === 'success') {
                            showToast('Deleted!', 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast(result.message || 'Failed to delete.', 'error');
                        }
                    } catch { showToast('Failed to delete.', 'error'); }
                }
            });
        });
    });
</script>
{% endblock %}
